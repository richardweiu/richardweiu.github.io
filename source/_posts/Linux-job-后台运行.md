---
title: Linux job 后台运行
date: 2017-01-25 19:29:09
tags: " Linux "
categories: " Linux "

---

> **前言**
　有时候会将一些工作时间较长的脚本或者小程序放到后台运行，这个时候我们就会用到 jobs，但是放到后台的 jobs 只活跃于当前的 shell 中，所示当前的 shell 关闭掉，放在后台的 jobs 也会被结束掉。

## Jobs 后台运行

我们经常会碰到这样的一种场景，用 ssh 远程登陆服务器，运行了一个非常耗时的任务或者脚本或者小程序等等，结果当前的网络出问题了，或者断掉了，当我们再次登陆时任务已经停止了，只能重新运行。如何才能让命令提交之后不会因为当前的 shell 断开而停止运行，有这样的几种方式：

- nohup 命令
- setsid 命令
- disown 命令
- tmux 工具

### nohub 命令

如果只是临时有一个命令需要长时间运行，什么方法能最简便的保证它在后台稳定运行呢？

我们知道，当用户注销（logout）或者网络断开时，终端会收到 HUP（hangup）信号从而关闭其所有子进程。nohup 的用途就是让提交的命令忽略 hangup 信号。

nohup 的使用是十分方便的，只需在要处理的命令前加上 nohup 即可，标准输出和标准错误缺省会被重定向到 nohup.out 文件中。一般我们可在结尾加上"&"来将命令同时放入后台运行，也可用 ` > filename 2>&1` 来更改缺省的重定向文件名。

例如原来老版本的 logstash 没有办法使用 service 来使其在后台工作，但是我们又不可能时时刻刻保持我们的 shell 都打开着，所以我们使用了这样的命令:

```
nohup /opt/logstash/bin/logstash -f /etc/logstash/conf.d/simple.conf &
```

这样就使得 logstash 即使在我们退出 shell 的时候也能够保持在后台继续运行着。（当然后来升级了，也就不存在这样的问题了）

### setsid 命令

nohup 无疑能通过忽略 HUP 信号来使我们的进程避免中途被中断，换一种解决方式，我们让我们的进程不属于当前的 shell 管理，这样就不会受到当前 shell 的影响了。例如上述命令我们可以改成这样：

```
setsid /opt/logstash/bin/logstash -f /etc/logstash/conf.d/simple.conf &
```

使用 setsid 命令之后的该进程的父进程则是 `init` 这个 `PID = 1` 的初始化进程，这样该进程就不会因为当前 shell 的中断或者退出而收到影响。我们可以通过 `ps -ef` 来验证一番，而 nohup 虽然不受当前 shell 的信号影响，但是其父进程还是当前 shell。

### disown 命令

事先在命令前加上 `nohup` 或者 `setsid` 就可以避免 HUP 信号的影响。但是如果我们未加任何处理就已经提交了命令，该如何补救才能让它避免 HUP 信号的影响呢？只有通过 disown 命令了。

- 用 `disown -h jobspec` 来使某个作业忽略HUP信号。
- 用 `disown -ah` 来使所有的作业都忽略HUP信号。
- 用 `disown -rh` 来使正在运行的作业忽略HUP信号。

>**注意**：需要注意的是，当使用过 disown 之后，会将把目标作业从作业列表中移除，我们将不能再使用 jobs 来查看它，但是依然能够用 `ps -ef` 查找到它。

我们应该知道：

- 通过在命令后面添加 `&` 我们可以是进程在后台中运行；
- 通过 `ctrl+z` 的快捷键我们能将当前的进程放入后台中挂起；
- 通过 fg 命令我们可以将后台中的进程放回至前台中继续运行；
- 通过 bg 命令我们可以是后台中暂停的程序继续运行；

### tmux 命令

tmux 是一个保存 session 的工具，与 screen 类似，但是 tmux 相对来说好用很多。

我们使用 ssh 登陆之后，使用 `tmux new -s session_name` 创建一个回话，tmux 会在后台中保持运行，及时我们断网了，或者直接关闭窗口等等我们的当时使用的 shell 都会保留着，这个就非常的方便了。

不仅如此 tmux 还能分屏等等，当然这些就与该章节的主题无关了。

tmux 的快捷键是 `前缀+特殊字母`。一般默认的前缀是 `ctrl+b`，常用的快捷键是：

- 前缀+c：创建一个新的窗口
- 前缀+p：切换到下一个窗口
- 前缀+d：挂载当前 session
- 前缀+[：翻开上文
- 前缀+%：屏幕分屏，分为左右两边
- 前缀+”：屏幕分屏，分为上下两边

通过这样的一种方式我们便可以让程序不受到 shell、网络的影响。

这是当时才上班不久就用到的一个需求，终于想着来记录了，当然这也不是我完全原创的，截取与参考 [IBM developerWorks 的 Linux 技巧](https://www.ibm.com/developerworks/cn/linux/l-cn-nohup/#icomments)

